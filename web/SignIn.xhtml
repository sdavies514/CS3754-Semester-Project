<?xml version="1.0" encoding="UTF-8"?>
<!--
Created by Shane Davies on 2017.11.18
Copyright Â© 2017 Shane Davies. All rights reserved.
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <!-- Do not enter tags before the composition line since they are ignored by JSF -->

    <!-- This page is constructed based on the siteTemplate -->
    <ui:composition template="template/siteTemplate.xhtml">
        <ui:define name="title">
            <!-- Set the page title -->
            <h:outputText value="Sign In"></h:outputText>
        </ui:define>

        <!-- Create the content for this page below -->
        <ui:define name="editableContent">
            <h:head>
                <!-- Initializes the Google API JavaScript files in order to user OAuth -->
<!--                <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
                </script>-->
                <script src="https://apis.google.com/js/client:platform.js?onload=start" async="defer">
                </script>
                <script>
                    function start() {
                        gapi.load('auth2', function () {
                            auth2 = gapi.auth2.init({
                                client_id: '152469586034-0gsehfd87qe5b58gr7jlvtopq2usreeb.apps.googleusercontent.com',
                                // Scopes to request in addition to 'profile' and 'email'
                                //scope: 'additional_scope'
                            });
                        });
                    }
                </script>
            </h:head>
            <div align="center" style="width:70%; margin:0 auto;">



                <!-- Error messages will be shown here if any -->
                <div align="center">
                    <p:messages showIcon="false"/>
                    <h:outputLabel id="form-error-message" class="errorMessages"
                                   value="#{loginManager.errorMessage}"/>
                </div>
                <br />

                <!--
                Makes use of the Google JavaScript API to log a user into our site via
                use of their Google account.
                -->
                <h:form id="loginForm">
                    <div id="my-signin2"></div>
                    <script>
                        //JavaScript function that is called upon successful authentication
                        function onSuccess(googleUser) {
                            //Hides the sign-in button after a successful login
                            $('#my-signin2').attr('style', 'display: none');
                            //Populates the hidden Primefaces fields with the information
                            //that is generated by Google from a successful authentication
                            document.getElementById("loginForm:googleUsername").value = googleUser.getBasicProfile().getEmail();
                            document.getElementById("loginForm:googleFirstName").value = googleUser.getBasicProfile().getGivenName();
                            document.getElementById("loginForm:googleLastName").value = googleUser.getBasicProfile().getFamilyName();
                            document.getElementById("loginForm:googleImageUrl").value = googleUser.getBasicProfile().getImageUrl();
                            document.getElementById("loginForm:googleId").value = googleUser.getBasicProfile().getId();
                            //Makes use of a new feature called Primefaces RemoteCommand
                            //This functionality allows for JavaScript to interact
                            //directly with the Java Beans located on the server
                            sendGoogleInfo();
                            //Delays the redirect to the Profile.xhtml page by half
                            //a second to allow for the information to be sent to the server
                            googleUser.disconnect();
                            setTimeout(function () {
                                window.location.href = "Profile.xhtml";
                            }, 500);
                        }
                        //JavaScript function that is called upon failed authentication
                        function onFailure(error) {
                            console.log(error);
                        }
                        //JavvaScript function that makes use of Google's own CSS
                        //styling to render the log in button
                        function renderButton() {
                            gapi.signin2.render('my-signin2', {
                                'scope': 'profile',
                                'width': 240,
                                'height': 50,
                                'longtitle': true,
                                'theme': 'dark',
                                'onsuccess': onSuccess,
                                'onfailure': onFailure
                            });
                        }
                    </script>
                    <br/>
                    <h2>Or Sign In with Your Thoughtware Account</h2>

                    <script src="https://apis.google.com/js/platform.js?onload=renderButton" async="defer"></script>

                    <script>
                    </script>

                    <!--
                    The RemoteCommand functionality mentioned earlier
                    When called it will call the signedInWithGoogle method that
                    is responsible for managing user information
                    -->
                    <p:remoteCommand name="sendGoogleInfo" actionListener="#{loginManager.signedInWithGoogle()}">
                    </p:remoteCommand>

                    <!--
                    Hidden fields that are used to transfer the information retrieved
                    from the JavaScript Google login to the Java Beans on the server-->
                    <h:inputHidden id="googleUsername" value="#{loginManager.googleUsername}"/>
                    <h:inputHidden id="googleFirstName" value="#{loginManager.googleFirstName}"/>
                    <h:inputHidden id="googleLastName" value="#{loginManager.googleLastName}"/>
                    <h:inputHidden id="googleImageUrl" value="#{loginManager.googleImageUrl}"/>
                    <h:inputHidden id="googleId" value="#{loginManager.googleId}"/>

                    <p:panelGrid columns="2" columnClasses="signInColumn1, signInColumn2">

                        <h:outputLabel value="Username:" for="username" />
                        <p:inputText id="username" value="#{loginManager.username}" required="true" styleClass="signInInputTextField"
                                     requiredMessage="#{bundle.CreateUserRequiredMessage_username}" label="Username" >
                        </p:inputText>

                        <h:outputLabel value="Password:" for="password" />
                        <p:password id="password" value="#{loginManager.password}" feedback="false" styleClass="signInInputTextField" >
                        </p:password>

                    </p:panelGrid>
                    <br/>
                    <br/>
                    <p:commandButton id="login" value="Sign In" action="#{loginManager.loginUser()}"
                                     styleClass="commandButton" ajax="false" icon="ui-icon-arrowthick-1-e" />
                    &nbsp;
                    <p:commandButton id="create" value="Create an Account" action="#{loginManager.createUser()}"
                                     styleClass="commandButton" ajax="false" icon="ui-icon-plus" />
                    &nbsp;
                    <p:commandButton id="retrieve" value="Forgot Password" action="#{loginManager.resetPassword()}"
                                     styleClass="commandButton" ajax="false" icon="ui-icon-refresh" />
                    &nbsp;
                    <p:button outcome="index" value="Cancel" icon="ui-icon-cancel" styleClass="commandButton" />
                </h:form>

            </div>
            <br/><br/><br/>
        </ui:define>
    </ui:composition>
    <!-- Do not enter tags after the composition line since they are ignored by JSF -->

</html>